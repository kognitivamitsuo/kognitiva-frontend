<!DOCTYPE html>
<html lang="pt-BR" data-framework-version="3.6" data-framework-blocks="B00-B19">
<head>
    <!-- Meta tags e t√≠tulo permanecem os mesmos -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kognitiva Chat</title>
    <style>
        /* Estilos CSS permanecem exatamente os mesmos */
        /* ... */
    </style>
</head>
<body>
    <!-- Estrutura HTML permanece exatamente a mesma -->
    <!-- ... -->

    <!-- Scripts JS - CAMINHOS ATUALIZADOS PARA ./utils/ -->
    <script src="./utils/contextService.js"></script>
    <script src="./utils/execControl.js"></script>
    <script src="./utils/executarIA.js"></script>
    <script src="./utils/reaproveitarSessao.js"></script>
    <script src="./utils/diagnosticoFinal.js"></script>
    <script src="./utils/feedbackBox.js"></script>
    
    <script>
        // 1. Fallback de JWT (OBRIGAT√ìRIO)
        if (!localStorage.getItem('kgn_jwt')) {
            fetch("https://sync.kognitiva.app/proxy/token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ projeto: "KOGNITIVA_2025" })
            })
            .then(res => {
                if (!res.ok) throw new Error('Falha ao obter token');
                return res.json();
            })
            .then(data => {
                if (data.token) {
                    localStorage.setItem('kgn_jwt', data.token);
                    console.log('Token JWT armazenado com sucesso');
                }
            })
            .catch(error => {
                console.error('Erro ao obter token:', error);
                localStorage.setItem('kgn_jwt', 'fallback_token_limited');
            });
        }

        // 2. Fun√ß√µes globais de fallback (caso n√£o estejam nos scripts)
        if (typeof enviarMensagem === 'undefined') {
            window.enviarMensagem = function(event) {
                event.preventDefault();
                const input = document.getElementById("inputMensagem");
                const mensagem = input.value.trim();
                if (!mensagem) return;

                // Exibir mensagem do usu√°rio
                renderMensagemUsuario(mensagem);
                
                // Chamar IA (se dispon√≠vel)
                if (typeof callKognitivaAPI !== 'undefined') {
                    callKognitivaAPI(mensagem)
                        .then(resposta => renderMensagemIA(resposta))
                        .catch(error => {
                            console.error("Erro na IA:", error);
                            renderMensagemIA("Desculpe, estou com problemas t√©cnicos. Tente novamente mais tarde.");
                        });
                } else {
                    renderMensagemIA("Sistema em manuten√ß√£o. Volte mais tarde.");
                }

                input.value = '';
            };
        }

        if (typeof renderMensagemIA === 'undefined') {
            window.renderMensagemIA = function(texto) {
                const chat = document.getElementById("chatMessages");
                const now = new Date();
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const messageDiv = document.createElement("div");
                messageDiv.className = "kgn-message kgn-ai";
                messageDiv.setAttribute("role", "article");
                messageDiv.innerHTML = `
                    <div class="kgn-message-content">${texto}</div>
                    <div class="kgn-message-meta">
                        <span class="kgn-time">${timeString}</span>
                        <span class="kgn-ai-label">Assistente</span>
                    </div>
                    <div class="feedback-box" data-framework-block="B17">
                        <p style="font-size: 0.75rem; color: var(--kgn-text-secondary);">Esta resposta foi √∫til?</p>
                        <button class="feedback-btn" aria-label="Gostei" onclick="enviarFeedback('positivo', '${Date.now()}')">üëç</button>
                        <button class="feedback-btn" aria-label="N√£o gostei" onclick="enviarFeedback('negativo', '${Date.now()}')">üëé</button>
                    </div>
                `;
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            };
        }

        if (typeof renderMensagemUsuario === 'undefined') {
            window.renderMensagemUsuario = function(texto) {
                const chat = document.getElementById("chatMessages");
                const now = new Date();
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const messageDiv = document.createElement("div");
                messageDiv.className = "kgn-message kgn-user";
                messageDiv.setAttribute("role", "article");
                messageDiv.innerHTML = `
                    <div class="kgn-message-content">${texto}</div>
                    <div class="kgn-message-meta">
                        <span class="kgn-time">${timeString}</span>
                        <span class="kgn-user-label">Voc√™</span>
                    </div>
                `;
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            };
        }

        // 3. Menu mobile
        document.getElementById('menuButton')?.addEventListener('click', function() {
            document.querySelector('.sidebar')?.classList.toggle('active');
        });

        // 4. Verifica√ß√£o de elementos obrigat√≥rios
        document.addEventListener('DOMContentLoaded', function() {
            const requiredElements = ['sidebarClientes', 'chatMessages', 'inputMensagem', 
                                    'botaoEnviar', 'lgpdAviso', 'diagnosticoFinal', 
                                    'botaoResetar'];
            
            const missing = requiredElements.filter(id => !document.getElementById(id));
            
            if (missing.length) {
                console.error("Elementos faltando:", missing);
            }

            // Verificar fun√ß√µes essenciais
            console.log("Fun√ß√µes dispon√≠veis:", {
                enviarMensagem: typeof enviarMensagem !== 'undefined',
                callKognitivaAPI: typeof callKognitivaAPI !== 'undefined',
                verificarReaproveitamentoSessao: typeof verificarReaproveitamentoSessao !== 'undefined'
            });

            // 5. Verifica√ß√£o alternativa de status
            fetch("https://sync.kognitiva.app/proxy/token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ projeto: "verificar" })
            })
            .catch(() => {
                renderMensagemIA("‚ö†Ô∏è Servi√ßo Temporariamente Indispon√≠vel. Algumas funcionalidades podem estar limitadas.");
            });
        });
    </script>
</body>
</html>
