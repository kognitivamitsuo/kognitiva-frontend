<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kognitiva Chat Din√¢mico Integrado</title>
<style>
  body {
    margin: 0; background-color: #343541; color: #f3f4f6;
    font-family: 'Segoe UI', sans-serif;
    display: flex; height: 100vh; overflow: hidden;
  }
  .sidebar {
    width: 240px;
    background-color: #202123;
    padding: 1rem;
    overflow-y: auto;
    border-right: 1px solid #555;
    box-sizing: border-box;
  }
  .sidebar h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    font-weight: 700;
  }
  .client-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .client-list li {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: 8px;
    user-select: none;
    transition: background-color 0.2s;
  }
  .client-list li:hover, .client-list li.active {
    background-color: #3b82f6;
    color: white;
  }
  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #2a2c38;
  }
  .chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    scroll-behavior: smooth;
  }
  .message {
    max-width: 75%;
    margin-bottom: 10px;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.4;
    word-wrap: break-word;
    font-size: 15px;
  }
  .message.ai {
    background-color: #f3f4f6;
    color: #111827;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }
  .message.user {
    background-color: #3b82f6;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    display: flex;
    align-items: center;
  }
  .chat-input-wrapper {
    display: flex;
    padding: 10px 15px;
    border-top: 1px solid #555;
    background-color: #343541;
  }
  .chat-input {
    flex: 1;
    padding: 12px 16px;
    font-size: 15px;
    border-radius: 20px;
    border: none;
    background-color: #1f2937;
    color: white;
    outline: none;
  }
  .send-btn {
    margin-left: 8px;
    background-color: #2563eb;
    border: none;
    border-radius: 12px;
    padding: 6px 12px;
    color: white;
    cursor: pointer;
    font-weight: 600;
    user-select: none;
  }
  .send-btn:hover {
    background-color: #1e40af;
  }
</style>
</head>
<body>
<!-- B15 ‚Äì LGPD -->
<div id="lgpdAviso" style="position:fixed;top:0;width:100%;background:#facc15;color:black;padding:0.5rem;text-align:center;font-size:14px;z-index:999;">
  ‚ö†Ô∏è Este chat respeita a LGPD. Ao continuar, voc√™ concorda com o uso dos dados conforme nossa pol√≠tica.
</div>

<div class="sidebar">
  <h2>Clientes</h2>
  <ul class="client-list" id="clientList"></ul>
</div>
<div class="chat-container">
  <div class="chat-messages" id="chatMessages">
    <div class="message ai">Ol√°! Sou a IA da Kognitiva. Como posso te ajudar hoje?</div>
  </div>
  <div class="chat-input-wrapper">
    <input type="text" id="inputMensagem" placeholder="Digite sua mensagem..." autocomplete="off" />
    <button class="send-btn" id="botaoEnviar">Enviar</button>
  </div>
</div>
<script>
(() => {
  const clientList = document.getElementById('clientList');
  const chatMessages = document.getElementById('chatMessages');
  const inputMensagem = document.getElementById('inputMensagem');
  const botaoEnviar = document.getElementById('botaoEnviar');
  let clientes = [];
  let clienteSelecionado = null;
  let tokenSessao = null;
  function adicionarMensagem(tipo, texto) {
    const msg = document.createElement('div');
    msg.className = `message ${tipo}`;
    msg.textContent = texto;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  async function enviarFeedback(tipo) {
    if (!tokenSessao || !clienteSelecionado) return;
    let feedbackUsuario = tipo === 'positivo' ? 'positivo' : '';
    let score = tipo === 'positivo' ? 10 : 4;
    if (tipo === 'negativo') {
      feedbackUsuario = prompt('Por favor, descreva o que podemos melhorar:');
      if (!feedbackUsuario) {
        adicionarMensagem('ai', 'Feedback negativo cancelado.');
        return;
      }
    }
    try {
      await fetch('https://sync.kognitiva.app/proxy/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cliente_nome: clienteSelecionado,
          feedback_usuario: feedbackUsuario,
          score_resposta: score,
        }),
      });
      adicionarMensagem('ai', tipo === 'positivo' ? 'üëç Feedback positivo registrado.' : 'üëé Feedback negativo registrado.');
    } catch {
      adicionarMensagem('ai', '‚ö†Ô∏è Erro ao registrar feedback.');
    }
  }
  async function enviarDiagnostico(modelo, score, tempoMs) {
    if (!tokenSessao || !clienteSelecionado) return;
    try {
      const response = await fetch('https://sync.kognitiva.app/proxy/diagnostico', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token_sessao: tokenSessao,
          cliente_nome: clienteSelecionado,
          modelo,
          score_resposta: score,
          tempo_total_ms: tempoMs,
        }),
      });
      const data = await response.json();
      if (data.classificacao) {
        adicionarMensagem('ai', `üìä Diagn√≥stico: ${data.classificacao}`);
      }
    } catch {
      adicionarMensagem('ai', '‚ö†Ô∏è Erro ao enviar diagn√≥stico.');
    }
  }
  function encerrarSessao() {
    adicionarMensagem('ai', 'üîí Sess√£o encerrada. Obrigado por usar a Kognitiva!');
    clienteSelecionado = null;
    localStorage.removeItem('clienteSelecionado');
    chatMessages.innerHTML = '';
  }
  async function obterToken() {
    try {
      const response = await fetch("https://sync.kognitiva.app/proxy/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "visitante_web",
          ip: "000.000.000.000",
          user_agent: navigator.userAgent,
        }),
      });
      const data = await response.json();
      if (response.ok && data.tokenConfirmado) {
        tokenSessao = data.token_sessao;
        console.log("üîê Token obtido com sucesso.");
      } else {
        console.error("‚ùå Falha ao obter token:", data);
      }
    } catch (err) {
      console.error("‚ùå Erro na requisi√ß√£o do token:", err);
    }
  }
  async function buscarClientes() {
    // Substituir por chamada real a API de clientes
    return ['Oriente Marketing', 'Nova Era Log√≠stica', 'Grupo SCC'];
  }
  async function buscarHistorico(cliente) {
    if (!tokenSessao) return [];
    try {
      const response = await fetch(`https://sync.kognitiva.app/proxy/contexto`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token_sessao: tokenSessao, contexto: { cliente_nome: cliente } }),
      });
      if (!response.ok) throw new Error("Falha ao buscar contexto");
      const data = await response.json();
      if (data && data.contexto && data.contexto.historico) {
        return data.contexto.historico;
      }
      return [];
    } catch (err) {
      console.error("Erro ao buscar hist√≥rico:", err);
      return [];
    }
  }
  function renderizarLista() {
    clientList.innerHTML = '';
    clientes.sort((a, b) => a.localeCompare(b));
    clientes.forEach(nome => {
      const li = document.createElement('li');
      li.textContent = nome;
      li.dataset.name = nome;
      if (nome === clienteSelecionado) li.classList.add('active');
      clientList.appendChild(li);
    });
  }
  function renderizarHistorico(mensagens) {
    chatMessages.innerHTML = '';
    if (!mensagens.length) {
      adicionarMensagem('ai', 'Ol√°! Sou a IA da Kognitiva. Como posso te ajudar hoje?');
      adicionarMensagem('ai', `‚úÖ Cliente selecionado: ${clienteSelecionado}`);
      return;
    }
    mensagens.forEach(m => {
      adicionarMensagem(m.tipo, m.texto);
    });
  }
  async function selecionarCliente(nome) {
    clienteSelecionado = nome;
    localStorage.setItem('clienteSelecionado', nome);
    renderizarLista();
    const historico = await buscarHistorico(nome);
    renderizarHistorico(historico);
  }
  async function enviarMensagem() {
    const texto = inputMensagem.value.trim();
    if (!texto || !clienteSelecionado || !tokenSessao) return;
    if (texto === '/encerrar') {
      encerrarSessao();
      inputMensagem.value = '';
      return;
    }
    if (texto === 'üëç') {
      await enviarFeedback('positivo');
      inputMensagem.value = '';
      return;
    }
    if (texto === 'üëé') {
      await enviarFeedback('negativo');
      inputMensagem.value = '';
      return;
    }
    adicionarMensagem('user', texto);
    inputMensagem.value = '';
    adicionarMensagem('ai', '‚åõ Processando resposta...');
    try {
      const response = await fetch('https://sync.kognitiva.app/executar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${tokenSessao}`,
        },
        body: JSON.stringify({
          token_sessao: tokenSessao,
          cliente_nome: clienteSelecionado,
          objetivo_interacao: texto,
        }),
      });
      const data = await response.json();
      const loadingMsg = [...chatMessages.children].find(div => div.textContent.includes('‚åõ Processando resposta'));
      if (loadingMsg) loadingMsg.remove();
      if (data.resposta) {
        adicionarMensagem('ai', data.resposta);
        if (data.modelo_utilizado && data.score_resposta != null) {
          adicionarMensagem('ai', `üß† Modelo: ${data.modelo_utilizado} | Score: ${data.score_resposta}`);
          await enviarDiagnostico(data.modelo_utilizado, data.score_resposta, 0);
        }
      }
    } catch {
      adicionarMensagem('ai', '‚ö†Ô∏è Erro ao comunicar com a IA.');
    }
  }
  botaoEnviar.onclick = enviarMensagem;
  inputMensagem.onkeydown = e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      enviarMensagem();
    }
  };
  clientList.onclick = e => {
    if (e.target.tagName === 'LI') {
      selecionarCliente(e.target.dataset.name);
    }
  };
  (async () => {
    await obterToken();
    clientes = await buscarClientes();
    renderizarLista();
    const salvo = localStorage.getItem('clienteSelecionado');
    if (salvo && clientes.includes(salvo)) {
      await selecionarCliente(salvo);
    }
  })();
})();
</script>
<script>

import { executarIA } from "./executarIA.js";
import { verificarReaproveitamentoSessao } from "./ReaproveitamentoSessao.js";
import { renderizarMensagem } from "./uiRenderer.js";

let tokenSessao = null;
let clienteSelecionado = null;

async function obterToken() {
  try {
    const resposta = await fetch("https://sync.kognitiva.app/proxy/token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: "usuario_teste",
        ip: "127.0.0.1",
        user_agent: navigator.userAgent,
        modo: "orquestracao",
      }),
    });

    const data = await resposta.json();
    tokenSessao = data.token_sessao;

    if (tokenSessao) {
      console.log("‚úî Token obtido com sucesso:", tokenSessao);
    } else {
      console.warn("‚ö† Token n√£o recebido. Verifique o backend.");
    }
  } catch (erro) {
    console.error("‚ùå Erro na requisi√ß√£o do token:", erro);
  }
}

function atualizarClientes(clientes) {
  const lista = document.getElementById("listaClientes");
  lista.innerHTML = "";

  clientes.forEach((nome) => {
    const botao = document.createElement("button");
    botao.textContent = nome;
    botao.onclick = () => selecionarCliente(nome);
    lista.appendChild(botao);
  });
}

async function selecionarCliente(nome) {
  clienteSelecionado = nome;
  document.getElementById("chatMessages").innerHTML = "";
  renderizarMensagem("ai", `‚úÖ Cliente selecionado: ${nome}`);

  if (!tokenSessao) {
    console.warn("‚ö† Token de sess√£o n√£o dispon√≠vel. Tentando obter novamente...");
    await obterToken();
  }

  if (tokenSessao) {
    verificarReaproveitamentoSessao(tokenSessao, nome);
  } else {
    renderizarMensagem("ai", "‚ö† Token de sess√£o indispon√≠vel. N√£o foi poss√≠vel continuar.");
  }
}

async function enviarMensagem() {
  const input = document.getElementById("inputMensagem");
  const texto = input.value.trim();
  if (!texto || !clienteSelecionado || !tokenSessao) return;

  renderizarMensagem("user", texto);
  input.value = "";

  const contexto_valido = true;
  const respostaIA = await executarIA(tokenSessao, clienteSelecionado, texto, contexto_valido);
  renderizarMensagem("ai", respostaIA);
}

document.addEventListener("DOMContentLoaded", async () => {
  await obterToken();

  const clientes = ["Grupo SCC", "Nova Era Log√≠stica", "Oriente Marketing"];
  atualizarClientes(clientes);

  const input = document.getElementById("inputMensagem");
  const botao = document.getElementById("botaoEnviar");
  botao.onclick = enviarMensagem;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") enviarMensagem();
  });
});

</script>
<script>
export async function executarIA(token, cliente, mensagem, contextoValido) {
  try {
    const resposta = await fetch("https://sync.kognitiva.app/executar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        cliente_nome: cliente,
        mensagem_usuario: mensagem,
        contexto_valido: contextoValido
      })
    });
    const dados = await resposta.json();
    return dados.resposta || "‚ö†Ô∏è Erro na resposta da IA.";
  } catch (erro) {
    return "‚ö†Ô∏è Erro ao executar IA.";
  }
}
</script>
<script>
export function salvarContexto(nome, contexto) {
  localStorage.setItem(nome, JSON.stringify(contexto));
}
export function obterContexto(nome) {
  const contexto = localStorage.getItem(nome);
  return contexto ? JSON.parse(contexto) : null;
}
</script>
<script>
export function renderizarDiagnosticoFinal(score) {
  const box = document.getElementById("diagnosticoFinal");
  box.innerHTML = `üìä Diagn√≥stico Final: Score ${score}/10`;
}
</script>
<script>
export function registrarFeedback(score, comentario) {
  fetch("https://sync.kognitiva.app/proxy/feedback", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ score_resposta: score, comentario_usuario: comentario })
  });
}
</script>
</body>
</html>
